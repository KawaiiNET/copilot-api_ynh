#!/bin/bash

source /usr/share/yunohost/helpers

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

ynh_systemctl --service="$app" --action="stop" --log_path="/var/log/$app/$app.log"

#=================================================
# UPGRADE DEPENDENCIES
#=================================================
ynh_script_progression "Upgrading Bun runtime..."

# Ensure Bun is installed using official installation script
# This is the recommended installation method per https://bun.sh/docs/installation
if ! command -v bun &> /dev/null; then
    export BUN_INSTALL="$install_dir/.bun"
    export HOME="$data_dir"
    curl -fsSL https://bun.sh/install | bash
    export PATH="$BUN_INSTALL/bin:$PATH"
fi

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Upgrading source files..."

# Download, check integrity, uncompress and patch the source from app.src
ynh_setup_source --dest_dir="$install_dir" --keep=".env"

# Set permissions
chown -R "$app:www-data" "$install_dir"
chmod -R 750 "$install_dir"

#=================================================
# REBUILD APP
#=================================================
ynh_script_progression "Building application..."

pushd "$install_dir"
    sudo -u "$app" env PATH="$PATH" "$install_dir/.bun/bin/bun" install --frozen-lockfile
    sudo -u "$app" env PATH="$PATH" "$install_dir/.bun/bin/bun" run build
popd

#=================================================
# UPDATE A CONFIG FILE
#=================================================
ynh_script_progression "Updating configuration..."

# Update NGINX configuration
ynh_config_add_nginx

# Update systemd configuration
ynh_config_add_systemd

# Update logrotate configuration
ynh_config_add_logrotate

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's systemd service..."

ynh_systemctl --service="$app" --action="start" --log_path="/var/log/$app/$app.log"

#=================================================
# END OF SCRIPT
#=================================================
ynh_script_progression "Upgrade of $app completed"
